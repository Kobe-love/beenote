import{d as ue,r as c,a as ie,u as de,x as me,y as ce,c as pe,b as _e,e as l,w as o,E as L,s as y,G as m,f as d,H as fe,o as V,h as w,I as ve,j as _,v as S,N as ge,O as Ve,A as he,P as be,Q as ye,_ as we}from"./index-xM3X1bgS.js";import{f as Ue,u as U,m as Ce,n as Ae,c as ke,d as xe}from"./index-BAxxpeKc.js";const $e={class:"users-container"},Ne={class:"header"},Be=ue({__name:"Users",setup(De){const T=c([]),C=c(!1),A=c(!1),v=c(!1),n=c(null),h=c(),s=ie({username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}),P={username:[{required:!0,message:"请输入用户名"}],email:[{type:"email",message:"请输入正确的邮箱地址"}]},k=async()=>{C.value=!0;try{const a=await Ue();T.value=a.data.map(e=>({...e,statusLoading:!1}))}catch(a){console.error(a),m.error("获取用户列表失败")}finally{C.value=!1}},R=()=>{h.value&&h.value.resetFields(),s.username="",s.password="",s.first_name="",s.last_name="",s.email="",s.role="user",s.is_active=!0,n.value=null},z=()=>{R(),v.value=!0},H=a=>{n.value=a,Object.assign(s,{username:a.username,password:"",first_name:a.first_name,last_name:a.last_name,email:a.email,role:a.role,is_active:a.is_active}),v.value=!0},Q=async a=>{a&&await a.validate(async e=>{if(e){A.value=!0;try{const r={username:s.username,first_name:s.first_name,last_name:s.last_name,email:s.email,role:s.role,is_active:s.is_active};s.password.trim()&&(r.password=s.password),n.value?(await U(n.value.id,r),m.success("更新成功")):(await Ce(r),m.success("创建成功")),v.value=!1,await k()}catch(r){console.error(r),m.error("保存失败")}finally{A.value=!1}}})},J=async a=>{try{await ye.confirm("确定要删除该用户吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ae(a.id),m.success("删除成功"),await k()}catch(e){e!=="cancel"&&(console.error(e),m.error("删除失败"))}},j=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"):"",K=async a=>{a.statusLoading=!0;try{await U(a.id,{is_active:a.is_active}),m.success(`已${a.is_active?"启用":"禁用"}用户`)}catch(e){console.error(e),m.error("更新状态失败"),a.is_active=!a.is_active}finally{a.statusLoading=!1}},x=c(!1),E=c("notes"),G=c([]),I=c([]),$=c(!1),N=c(!1),W=async a=>{n.value=a,x.value=!0,await Promise.all([X(),Y()])},X=async()=>{if(n.value){$.value=!0;try{const a=await ke();G.value=a.data.results.map(e=>{var r;return{...e,hasAuth:(r=n.value.notes)==null?void 0:r.includes(e.id)}})}catch(a){console.error(a),m.error("获取笔记列表失败")}finally{$.value=!1}}},Y=async()=>{if(n.value){N.value=!0;try{const a=await xe();I.value=a.data.map(e=>{var r;return{...e,hasAuth:(r=n.value.note_group)==null?void 0:r.includes(e.id)}})}catch(a){console.error(a),m.error("获取分组列表失败")}finally{N.value=!1}}},Z=async a=>{var e,r;if(n.value)try{const i=a.hasAuth?[...n.value.notes||[],a.id]:(n.value.notes||[]).filter(u=>u!==a.id);await U(n.value.id,{note:i,note_group:n.value.note_group||[]}),n.value.notes=i,m.success("笔记授权更新成功")}catch(i){console.error(i),m.error(((r=(e=i.response)==null?void 0:e.data)==null?void 0:r.detail)||"笔记授权更新失败"),a.hasAuth=!a.hasAuth}},ee=async a=>{var e,r;if(n.value)try{const i=a.hasAuth?[...n.value.note_group||[],a.id]:(n.value.note_group||[]).filter(u=>u!==a.id);await U(n.value.id,{note:n.value.notes||[],note_group:i}),n.value.note_group=i,m.success("分组授权更新成功")}catch(i){console.error(i),m.error(((r=(e=i.response)==null?void 0:e.data)==null?void 0:r.detail)||"分组授权更新失败"),a.hasAuth=!a.hasAuth}},ae=de(),le=me(()=>{var a;return((a=ae.user)==null?void 0:a.role)==="admin"});return ce(()=>{k()}),(a,e)=>{var O;const r=d("el-icon"),i=d("el-button"),u=d("el-table-column"),te=d("el-tag"),b=d("el-switch"),oe=d("el-button-group"),B=d("el-table"),g=d("el-input"),f=d("el-form-item"),M=d("el-option"),se=d("el-select"),ne=d("el-form"),q=d("el-dialog"),F=d("el-tab-pane"),re=d("el-tabs"),D=fe("loading");return V(),pe("div",$e,[_e("div",Ne,[l(i,{type:"primary",onClick:z},{default:o(()=>[l(r,null,{default:o(()=>[l(w(ve))]),_:1}),e[12]||(e[12]=_("新建用户 "))]),_:1})]),L((V(),y(B,{data:T.value,stripe:""},{default:o(()=>[l(u,{prop:"username",label:"用户名"}),l(u,{prop:"first_name",label:"姓"}),l(u,{prop:"last_name",label:"名"}),l(u,{prop:"email",label:"邮箱"}),l(u,{prop:"role",label:"角色"},{default:o(({row:t})=>[l(te,null,{default:o(()=>[_(S(t.role),1)]),_:2},1024)]),_:1}),l(u,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:t})=>[l(b,{modelValue:t.is_active,"onUpdate:modelValue":p=>t.is_active=p,loading:t.statusLoading,onChange:p=>K(t),"active-text":t.is_active?"启用":"禁用","inline-prompt":""},null,8,["modelValue","onUpdate:modelValue","loading","onChange","active-text"])]),_:1}),l(u,{prop:"last_active_at",label:"最后活跃时间"},{default:o(({row:t})=>[_(S(j(t.last_active_at)),1)]),_:1}),l(u,{prop:"date_joined",label:"加入时间"},{default:o(({row:t})=>[_(S(j(t.date_joined)),1)]),_:1}),l(u,{label:"操作",width:"280",fixed:"right"},{default:o(({row:t})=>[l(oe,null,{default:o(()=>[l(i,{type:"primary",icon:w(ge),onClick:p=>H(t)},{default:o(()=>e[13]||(e[13]=[_(" 编辑 ")])),_:2},1032,["icon","onClick"]),le.value?(V(),y(i,{key:0,type:"success",icon:w(Ve),onClick:p=>W(t)},{default:o(()=>e[14]||(e[14]=[_(" 授权 ")])),_:2},1032,["icon","onClick"])):he("",!0),l(i,{type:"danger",icon:w(be),onClick:p=>J(t)},{default:o(()=>e[15]||(e[15]=[_(" 删除 ")])),_:2},1032,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[D,C.value]]),l(q,{modelValue:v.value,"onUpdate:modelValue":e[9]||(e[9]=t=>v.value=t),title:n.value?"编辑用户":"新建用户",width:"500px"},{footer:o(()=>[l(i,{onClick:e[7]||(e[7]=t=>v.value=!1)},{default:o(()=>e[16]||(e[16]=[_("取消")])),_:1}),l(i,{type:"primary",onClick:e[8]||(e[8]=t=>Q(h.value)),loading:A.value},{default:o(()=>e[17]||(e[17]=[_(" 确定 ")])),_:1},8,["loading"])]),default:o(()=>[l(ne,{ref_key:"formRef",ref:h,model:s,rules:P,"label-width":"100px"},{default:o(()=>[l(f,{label:"用户名",prop:"username"},{default:o(()=>[l(g,{modelValue:s.username,"onUpdate:modelValue":e[0]||(e[0]=t=>s.username=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"密码",prop:"password",rules:[{required:!n.value,message:"请输入密码"}]},{default:o(()=>[l(g,{modelValue:s.password,"onUpdate:modelValue":e[1]||(e[1]=t=>s.password=t),type:"password",placeholder:n.value?"不修改请留空":"请输入密码"},null,8,["modelValue","placeholder"])]),_:1},8,["rules"]),l(f,{label:"姓",prop:"first_name"},{default:o(()=>[l(g,{modelValue:s.first_name,"onUpdate:modelValue":e[2]||(e[2]=t=>s.first_name=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"名",prop:"last_name"},{default:o(()=>[l(g,{modelValue:s.last_name,"onUpdate:modelValue":e[3]||(e[3]=t=>s.last_name=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"邮箱",prop:"email"},{default:o(()=>[l(g,{modelValue:s.email,"onUpdate:modelValue":e[4]||(e[4]=t=>s.email=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"角色",prop:"role"},{default:o(()=>[l(se,{modelValue:s.role,"onUpdate:modelValue":e[5]||(e[5]=t=>s.role=t)},{default:o(()=>[l(M,{label:"管理员",value:"admin"}),l(M,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"状态",prop:"is_active"},{default:o(()=>[l(b,{modelValue:s.is_active,"onUpdate:modelValue":e[6]||(e[6]=t=>s.is_active=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(q,{modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=t=>x.value=t),title:`${((O=n.value)==null?void 0:O.name)||""} 的授权管理`,width:"800px"},{default:o(()=>[l(re,{modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=t=>E.value=t)},{default:o(()=>[l(F,{label:"笔记授权",name:"notes"},{default:o(()=>[L((V(),y(B,{data:G.value,style:{width:"100%"}},{default:o(()=>[l(u,{prop:"title",label:"笔记名称"}),l(u,{prop:"group_detail.name",label:"所属分组"}),l(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(b,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>Z(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[D,$.value]])]),_:1}),l(F,{label:"分组授权",name:"groups"},{default:o(()=>[L((V(),y(B,{data:I.value,style:{width:"100%"}},{default:o(()=>[l(u,{prop:"name",label:"分组名称"}),l(u,{prop:"description",label:"描述"}),l(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(b,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>ee(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[D,N.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),Te=we(Be,[["__scopeId","data-v-e3df06f3"]]);export{Te as default};

import{d as ie,r as c,a as de,u as me,x as ce,y as pe,c as _e,b as fe,e as l,w as o,E as S,s as w,G as d,f as m,H as ve,o as b,h as V,I as ge,j as _,v as T,N as be,O as Ve,A as he,P as ye,Q as we,_ as Ue}from"./index-B1xyQZS1.js";import{f as Ce,u as U,m as Ae,n as ke,c as xe,d as $e}from"./index-BzLWzpi_.js";const Ne={class:"users-container"},Be={class:"header"},De=ie({__name:"Users",setup(Le){const j=c([]),C=c(!1),A=c(!1),v=c(!1),n=c(null),h=c(),s=de({username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}),z={username:[{required:!0,message:"请输入用户名"}],email:[{type:"email",message:"请输入正确的邮箱地址"}]},k=async()=>{C.value=!0;try{const a=await Ce();j.value=a.data.map(e=>({...e,statusLoading:!1}))}catch(a){console.error(a),d.error("获取用户列表失败")}finally{C.value=!1}},H=()=>{h.value&&h.value.resetFields(),s.username="",s.password="",s.first_name="",s.last_name="",s.email="",s.role="user",s.is_active=!0,n.value=null},Q=()=>{H(),v.value=!0},J=a=>{n.value=a,Object.assign(s,{username:a.username,password:"",first_name:a.first_name,last_name:a.last_name,email:a.email,role:a.role,is_active:a.is_active}),v.value=!0},K=async a=>{a&&await a.validate(async e=>{if(e){A.value=!0;try{const r={username:s.username,first_name:s.first_name,last_name:s.last_name,email:s.email,role:s.role,is_active:s.is_active};s.password.trim()&&(r.password=s.password),n.value?(await U(n.value.id,r),d.success("更新成功")):(await Ae(r),d.success("创建成功")),v.value=!1,await k()}catch(r){console.error(r),d.error("保存失败")}finally{A.value=!1}}})},W=async a=>{try{await we.confirm("确定要删除该用户吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ke(a.id),d.success("删除成功"),await k()}catch(e){e!=="cancel"&&(console.error(e),d.error("删除失败"))}},E=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"):"",X=async a=>{var e;if(a.username===((e=B.user)==null?void 0:e.username)&&!a.is_active){d.warning("不能禁用自己的账号"),a.is_active=!0;return}a.statusLoading=!0;try{await U(a.id,{is_active:a.is_active}),d.success(`已${a.is_active?"启用":"禁用"}用户`)}catch(r){console.error(r),d.error("更新状态失败"),a.is_active=!a.is_active}finally{a.statusLoading=!1}},x=c(!1),G=c("notes"),I=c([]),M=c([]),$=c(!1),N=c(!1),Y=async a=>{n.value=a,x.value=!0,await Promise.all([Z(),ee()])},Z=async()=>{if(n.value){$.value=!0;try{const a=await xe();I.value=a.data.results.map(e=>{var r;return{...e,hasAuth:(r=n.value.notes)==null?void 0:r.includes(e.id)}})}catch(a){console.error(a),d.error("获取笔记列表失败")}finally{$.value=!1}}},ee=async()=>{if(n.value){N.value=!0;try{const a=await $e();M.value=a.data.map(e=>{var r;return{...e,hasAuth:(r=n.value.note_group)==null?void 0:r.includes(e.id)}})}catch(a){console.error(a),d.error("获取分组列表失败")}finally{N.value=!1}}},ae=async a=>{var e,r;if(n.value)try{const i=a.hasAuth?[...n.value.notes||[],a.id]:(n.value.notes||[]).filter(u=>u!==a.id);await U(n.value.id,{note:i,note_group:n.value.note_group||[]}),n.value.notes=i,d.success("笔记授权更新成功")}catch(i){console.error(i),d.error(((r=(e=i.response)==null?void 0:e.data)==null?void 0:r.detail)||"笔记授权更新失败"),a.hasAuth=!a.hasAuth}},le=async a=>{var e,r;if(n.value)try{const i=a.hasAuth?[...n.value.note_group||[],a.id]:(n.value.note_group||[]).filter(u=>u!==a.id);await U(n.value.id,{note:n.value.notes||[],note_group:i}),n.value.note_group=i,d.success("分组授权更新成功")}catch(i){console.error(i),d.error(((r=(e=i.response)==null?void 0:e.data)==null?void 0:r.detail)||"分组授权更新失败"),a.hasAuth=!a.hasAuth}},B=me(),te=ce(()=>{var a;return((a=B.user)==null?void 0:a.role)==="admin"});return pe(()=>{k()}),(a,e)=>{var P;const r=m("el-icon"),i=m("el-button"),u=m("el-table-column"),oe=m("el-tag"),y=m("el-switch"),se=m("el-button-group"),D=m("el-table"),g=m("el-input"),f=m("el-form-item"),q=m("el-option"),ne=m("el-select"),re=m("el-form"),F=m("el-dialog"),O=m("el-tab-pane"),ue=m("el-tabs"),L=ve("loading");return b(),_e("div",Ne,[fe("div",Be,[l(i,{type:"primary",onClick:Q},{default:o(()=>[l(r,null,{default:o(()=>[l(V(ge))]),_:1}),e[12]||(e[12]=_("新建用户 "))]),_:1})]),S((b(),w(D,{data:j.value,stripe:""},{default:o(()=>[l(u,{prop:"username",label:"用户名"}),l(u,{prop:"first_name",label:"姓"}),l(u,{prop:"last_name",label:"名"}),l(u,{prop:"email",label:"邮箱"}),l(u,{prop:"role",label:"角色"},{default:o(({row:t})=>[l(oe,null,{default:o(()=>[_(T(t.role),1)]),_:2},1024)]),_:1}),l(u,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:t})=>{var p;return[l(y,{modelValue:t.is_active,"onUpdate:modelValue":R=>t.is_active=R,loading:t.statusLoading,onChange:R=>X(t),"active-text":t.is_active?"启用":"禁用",disabled:t.username===((p=V(B).user)==null?void 0:p.username),"inline-prompt":""},null,8,["modelValue","onUpdate:modelValue","loading","onChange","active-text","disabled"])]}),_:1}),l(u,{prop:"last_active_at",label:"最后活跃时间"},{default:o(({row:t})=>[_(T(E(t.last_active_at)),1)]),_:1}),l(u,{prop:"date_joined",label:"加入时间"},{default:o(({row:t})=>[_(T(E(t.date_joined)),1)]),_:1}),l(u,{label:"操作",width:"280",fixed:"right"},{default:o(({row:t})=>[l(se,null,{default:o(()=>[l(i,{type:"primary",icon:V(be),onClick:p=>J(t)},{default:o(()=>e[13]||(e[13]=[_(" 编辑 ")])),_:2},1032,["icon","onClick"]),te.value?(b(),w(i,{key:0,type:"success",icon:V(Ve),onClick:p=>Y(t)},{default:o(()=>e[14]||(e[14]=[_(" 授权 ")])),_:2},1032,["icon","onClick"])):he("",!0),l(i,{type:"danger",icon:V(ye),onClick:p=>W(t)},{default:o(()=>e[15]||(e[15]=[_(" 删除 ")])),_:2},1032,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[L,C.value]]),l(F,{modelValue:v.value,"onUpdate:modelValue":e[9]||(e[9]=t=>v.value=t),title:n.value?"编辑用户":"新建用户",width:"500px"},{footer:o(()=>[l(i,{onClick:e[7]||(e[7]=t=>v.value=!1)},{default:o(()=>e[16]||(e[16]=[_("取消")])),_:1}),l(i,{type:"primary",onClick:e[8]||(e[8]=t=>K(h.value)),loading:A.value},{default:o(()=>e[17]||(e[17]=[_(" 确定 ")])),_:1},8,["loading"])]),default:o(()=>[l(re,{ref_key:"formRef",ref:h,model:s,rules:z,"label-width":"100px"},{default:o(()=>[l(f,{label:"用户名",prop:"username"},{default:o(()=>[l(g,{modelValue:s.username,"onUpdate:modelValue":e[0]||(e[0]=t=>s.username=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"密码",prop:"password",rules:[{required:!n.value,message:"请输入密码"}]},{default:o(()=>[l(g,{modelValue:s.password,"onUpdate:modelValue":e[1]||(e[1]=t=>s.password=t),type:"password",placeholder:n.value?"不修改请留空":"请输入密码"},null,8,["modelValue","placeholder"])]),_:1},8,["rules"]),l(f,{label:"姓",prop:"first_name"},{default:o(()=>[l(g,{modelValue:s.first_name,"onUpdate:modelValue":e[2]||(e[2]=t=>s.first_name=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"名",prop:"last_name"},{default:o(()=>[l(g,{modelValue:s.last_name,"onUpdate:modelValue":e[3]||(e[3]=t=>s.last_name=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"邮箱",prop:"email"},{default:o(()=>[l(g,{modelValue:s.email,"onUpdate:modelValue":e[4]||(e[4]=t=>s.email=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"角色",prop:"role"},{default:o(()=>[l(ne,{modelValue:s.role,"onUpdate:modelValue":e[5]||(e[5]=t=>s.role=t)},{default:o(()=>[l(q,{label:"管理员",value:"admin"}),l(q,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"状态",prop:"is_active"},{default:o(()=>[l(y,{modelValue:s.is_active,"onUpdate:modelValue":e[6]||(e[6]=t=>s.is_active=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(F,{modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=t=>x.value=t),title:`${((P=n.value)==null?void 0:P.name)||""} 的授权管理`,width:"800px"},{default:o(()=>[l(ue,{modelValue:G.value,"onUpdate:modelValue":e[10]||(e[10]=t=>G.value=t)},{default:o(()=>[l(O,{label:"笔记授权",name:"notes"},{default:o(()=>[S((b(),w(D,{data:I.value,style:{width:"100%"}},{default:o(()=>[l(u,{prop:"title",label:"笔记名称"}),l(u,{prop:"group_detail.name",label:"所属分组"}),l(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(y,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>ae(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[L,$.value]])]),_:1}),l(O,{label:"分组授权",name:"groups"},{default:o(()=>[S((b(),w(D,{data:M.value,style:{width:"100%"}},{default:o(()=>[l(u,{prop:"name",label:"分组名称"}),l(u,{prop:"description",label:"描述"}),l(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(y,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>le(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[L,N.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),je=Ue(De,[["__scopeId","data-v-6a61eda6"]]);export{je as default};

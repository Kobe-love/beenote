import{d as ce,r as c,a as _e,u as fe,y as ve,o as ge,c as be,b as he,e as l,w as o,G as M,t as x,E as d,h as m,H as Ve,j as w,k as g,I as ye,p as _,x as U,N as we,O as Ue,A as Ce,P as Ae,Q as xe,_ as ke}from"./index-BSenUYUZ.js";import{f as $e,u as k,m as Ee,n as Ne,c as Be,d as Le}from"./index-86TX0eNp.js";const Te={class:"users-container"},De={class:"header"},Me=ce({__name:"Users",setup(Se){const S=c([]),V=c(!1),Q=c(!1),b=c(!1),Z=c(""),s=c(null),C=c(),r=_e({username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}),F={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{validator:(a,e,n)=>{e.length<6?n(new Error("密码长度至少为6位，并同时包含大小写字母和数字")):/[A-Z]/.test(e)?/[a-z]/.test(e)?/\d/.test(e)?n():n(new Error("密码长度至少为6位，并同时包含大小写字母和数字")):n(new Error("密码长度至少为6位，并同时包含大小写字母和数字")):n(new Error("密码长度至少为6位，并同时包含大小写字母和数字"))},trigger:"change"}],role:[{required:!0,message:"请选择角色",trigger:"change"}]},$=async()=>{V.value=!0;try{const a=await $e();S.value=a.data.map(e=>({...e,statusLoading:!1}))}catch(a){console.error(a),d.error("获取用户列表失败")}finally{V.value=!1}},J=()=>{b.value=!0,Z.value="新建用户",r.value={username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}},K=a=>{s.value=a,Object.assign(r,{username:a.username,password:"",first_name:a.first_name,last_name:a.last_name,email:a.email,role:a.role,is_active:a.is_active}),b.value=!0},W=()=>{C.value&&C.value.validate(a=>{a&&(V.value=!0,b.value=!1,(s.value?k(s.value.id,r):Ee(r)).then(()=>{d.success("保存成功"),b.value=!1,$()}).catch(n=>{d.error(n.message||"保存失败")}).finally(()=>{V.value=!1}))})},X=async a=>{var e;if(a.username===((e=f.user)==null?void 0:e.username)){d.warning("不能删除自己的账号");return}try{await xe.confirm("确定要删除该用户吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ne(a.id),d.success("删除成功"),await $()}catch(n){n!=="cancel"&&(console.error(n),d.error("删除失败"))}},j=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"):"",Y=async a=>{var e;if(a.username===((e=f.user)==null?void 0:e.username)&&!a.is_active){d.warning("不能禁用自己的账号"),a.is_active=!0;return}a.statusLoading=!0;try{await k(a.id,{is_active:a.is_active}),d.success(`已${a.is_active?"启用":"禁用"}用户`)}catch(n){console.error(n),d.error("更新状态失败"),a.is_active=!a.is_active}finally{a.statusLoading=!1}},E=c(!1),q=c("notes"),G=c([]),I=c([]),N=c(!1),B=c(!1),ee=async a=>{s.value=a,E.value=!0,await Promise.all([ae(),te()])},ae=async()=>{if(s.value){N.value=!0;try{const a=await Be();G.value=a.data.results.map(e=>{var n;return{...e,hasAuth:(n=s.value.notes)==null?void 0:n.includes(e.id)}})}catch(a){console.error(a),d.error("获取笔记列表失败")}finally{N.value=!1}}},te=async()=>{if(s.value){B.value=!0;try{const a=await Le();I.value=a.data.map(e=>{var n;return{...e,hasAuth:(n=s.value.note_group)==null?void 0:n.includes(e.id)}})}catch(a){console.error(a),d.error("获取分组列表失败")}finally{B.value=!1}}},le=async a=>{var e,n;if(s.value)try{const u=a.hasAuth?[...s.value.notes||[],a.id]:(s.value.notes||[]).filter(i=>i!==a.id);await k(s.value.id,{note:u,note_group:s.value.note_group||[]}),s.value.notes=u,d.success("笔记授权更新成功")}catch(u){console.error(u),d.error(((n=(e=u.response)==null?void 0:e.data)==null?void 0:n.detail)||"笔记授权更新失败"),a.hasAuth=!a.hasAuth}},oe=async a=>{var e,n;if(s.value)try{const u=a.hasAuth?[...s.value.note_group||[],a.id]:(s.value.note_group||[]).filter(i=>i!==a.id);await k(s.value.id,{note:s.value.notes||[],note_group:u}),s.value.note_group=u,d.success("分组授权更新成功")}catch(u){console.error(u),d.error(((n=(e=u.response)==null?void 0:e.data)==null?void 0:n.detail)||"分组授权更新失败"),a.hasAuth=!a.hasAuth}},f=fe(),R=ve(()=>{var a,e;return((a=f.user)==null?void 0:a.role)==="admin"||((e=f.user)==null?void 0:e.role)==="superuser"}),se=a=>({superuser:"超级管理员",admin:"管理员",user:"普通用户"})[a]||a,ne=a=>({superuser:"danger",admin:"warning",user:"success"})[a]||"";return ge(()=>{$()}),(a,e)=>{var P;const n=m("el-icon"),u=m("el-button"),i=m("el-table-column"),re=m("el-tag"),A=m("el-switch"),ue=m("el-button-group"),L=m("el-table"),y=m("el-input"),h=m("el-form-item"),T=m("el-option"),ie=m("el-select"),de=m("el-form"),z=m("el-dialog"),O=m("el-tab-pane"),me=m("el-tabs"),D=Ve("loading");return w(),be("div",Te,[he("div",De,[l(u,{type:"primary",onClick:J},{default:o(()=>[l(n,null,{default:o(()=>[l(g(ye))]),_:1}),e[12]||(e[12]=_("新建用户 "))]),_:1})]),M((w(),x(L,{data:S.value,stripe:""},{default:o(()=>[l(i,{prop:"username",label:"用户名"}),l(i,{prop:"first_name",label:"姓名"},{default:o(({row:t})=>[_(U(t.first_name)+" "+U(t.last_name),1)]),_:1}),l(i,{prop:"email",label:"邮箱"}),l(i,{prop:"role",label:"角色"},{default:o(({row:t})=>[l(re,{type:ne(t.role)},{default:o(()=>[_(U(se(t.role)),1)]),_:2},1032,["type"])]),_:1}),l(i,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:t})=>{var p;return[l(A,{modelValue:t.is_active,"onUpdate:modelValue":v=>t.is_active=v,loading:t.statusLoading,onChange:v=>Y(t),"active-text":t.is_active?"启用":"禁用",disabled:t.username===((p=g(f).user)==null?void 0:p.username),"inline-prompt":""},null,8,["modelValue","onUpdate:modelValue","loading","onChange","active-text","disabled"])]}),_:1}),l(i,{prop:"last_active_at",label:"最后活跃时间"},{default:o(({row:t})=>[_(U(j(t.last_active_at)),1)]),_:1}),l(i,{prop:"date_joined",label:"加入时间"},{default:o(({row:t})=>[_(U(j(t.date_joined)),1)]),_:1}),l(i,{label:"操作",width:R.value?280:200,fixed:"right"},{default:o(({row:t})=>[l(ue,null,{default:o(()=>{var p;return[l(u,{type:"primary",icon:g(we),onClick:v=>K(t)},{default:o(()=>e[13]||(e[13]=[_(" 编辑 ")])),_:2},1032,["icon","onClick"]),R.value?(w(),x(u,{key:0,type:"success",icon:g(Ue),onClick:v=>ee(t)},{default:o(()=>e[14]||(e[14]=[_(" 授权 ")])),_:2},1032,["icon","onClick"])):Ce("",!0),l(u,{type:"danger",icon:g(Ae),disabled:t.username===((p=g(f).user)==null?void 0:p.username),onClick:v=>X(t)},{default:o(()=>e[15]||(e[15]=[_(" 删除 ")])),_:2},1032,["icon","disabled","onClick"])]}),_:2},1024)]),_:1},8,["width"])]),_:1},8,["data"])),[[D,V.value]]),l(z,{modelValue:b.value,"onUpdate:modelValue":e[9]||(e[9]=t=>b.value=t),title:s.value?"编辑用户":"新建用户",width:"500px"},{footer:o(()=>[l(u,{onClick:e[7]||(e[7]=t=>b.value=!1)},{default:o(()=>e[16]||(e[16]=[_("取消")])),_:1}),l(u,{type:"primary",onClick:e[8]||(e[8]=t=>W(C.value)),loading:Q.value},{default:o(()=>e[17]||(e[17]=[_(" 确定 ")])),_:1},8,["loading"])]),default:o(()=>[l(de,{ref_key:"formRef",ref:C,model:r,rules:F,"label-width":"100px"},{default:o(()=>[l(h,{label:"用户名",prop:"username"},{default:o(()=>[l(y,{modelValue:r.username,"onUpdate:modelValue":e[0]||(e[0]=t=>r.username=t)},null,8,["modelValue"])]),_:1}),l(h,{label:"密码",prop:"password",rules:[{required:!s.value,message:"请输入密码"}]},{default:o(()=>{var t,p,v,H;return[l(y,{modelValue:r.password,"onUpdate:modelValue":e[1]||(e[1]=pe=>r.password=pe),type:"password",disabled:((t=s.value)==null?void 0:t.username)===((p=g(f).user)==null?void 0:p.username),placeholder:((v=s.value)==null?void 0:v.username)===((H=g(f).user)==null?void 0:H.username)?"不能修改自己的密码":s.value?"不修改请留空":"请输入密码"},null,8,["modelValue","disabled","placeholder"])]}),_:1},8,["rules"]),l(h,{label:"姓",prop:"first_name"},{default:o(()=>[l(y,{modelValue:r.first_name,"onUpdate:modelValue":e[2]||(e[2]=t=>r.first_name=t)},null,8,["modelValue"])]),_:1}),l(h,{label:"名",prop:"last_name"},{default:o(()=>[l(y,{modelValue:r.last_name,"onUpdate:modelValue":e[3]||(e[3]=t=>r.last_name=t)},null,8,["modelValue"])]),_:1}),l(h,{label:"邮箱",prop:"email"},{default:o(()=>[l(y,{modelValue:r.email,"onUpdate:modelValue":e[4]||(e[4]=t=>r.email=t)},null,8,["modelValue"])]),_:1}),l(h,{label:"角色",prop:"role"},{default:o(()=>[l(ie,{modelValue:r.role,"onUpdate:modelValue":e[5]||(e[5]=t=>r.role=t)},{default:o(()=>[l(T,{label:"超级管理员",value:"superuser"}),l(T,{label:"管理员",value:"admin"}),l(T,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"状态",prop:"is_active"},{default:o(()=>[l(A,{modelValue:r.is_active,"onUpdate:modelValue":e[6]||(e[6]=t=>r.is_active=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(z,{modelValue:E.value,"onUpdate:modelValue":e[11]||(e[11]=t=>E.value=t),title:`${((P=s.value)==null?void 0:P.name)||""} 的授权管理`,width:"800px"},{default:o(()=>[l(me,{modelValue:q.value,"onUpdate:modelValue":e[10]||(e[10]=t=>q.value=t)},{default:o(()=>[l(O,{label:"笔记授权",name:"notes"},{default:o(()=>[M((w(),x(L,{data:G.value,style:{width:"100%"}},{default:o(()=>[l(i,{prop:"title",label:"笔记名称"}),l(i,{prop:"group_detail.name",label:"所属分组"}),l(i,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(A,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>le(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[D,N.value]])]),_:1}),l(O,{label:"分组授权",name:"groups"},{default:o(()=>[M((w(),x(L,{data:I.value,style:{width:"100%"}},{default:o(()=>[l(i,{prop:"name",label:"分组名称"}),l(i,{prop:"description",label:"描述"}),l(i,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[l(A,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>oe(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[D,B.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),Ge=ke(Me,[["__scopeId","data-v-5b934de0"]]);export{Ge as default};

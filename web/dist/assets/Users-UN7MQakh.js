import{d as se,r as c,a as ue,q as re,c as ie,b as de,e as a,w as o,E as D,s as L,G as m,f as i,H as me,o as h,h as y,I as ce,j as _,y as E,N as pe,O as _e,P as fe,Q as ve,_ as ge}from"./index-Df5Rugzl.js";import{e as Ve,u as w,m as be,n as he,b as ye,c as we}from"./index-DzkZSsWB.js";const Ue={class:"users-container"},Ce={class:"header"},Ae=se({__name:"Users",setup(ke){const T=c([]),U=c(!1),C=c(!1),v=c(!1),s=c(null),g=c(),n=ue({username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}),z={username:[{required:!0,message:"请输入用户名"}],email:[{type:"email",message:"请输入正确的邮箱地址"}]},A=async()=>{U.value=!0;try{const l=await Ve();T.value=l.data.map(e=>({...e,statusLoading:!1}))}catch(l){console.error(l),m.error("获取用户列表失败")}finally{U.value=!1}},G=()=>{g.value&&g.value.resetFields(),n.username="",n.password="",n.first_name="",n.last_name="",n.email="",n.role="user",n.is_active=!0,s.value=null},H=()=>{G(),v.value=!0},O=l=>{s.value=l,n.username=l.username,n.password="",n.first_name=l.first_name,n.last_name=l.last_name,n.email=l.email,n.role=l.role,n.is_active=l.is_active,v.value=!0},Q=async()=>{g.value&&await g.value.validate(async l=>{if(l){C.value=!0;try{const e={...n};s.value?(e.password||delete e.password,await w(s.value.id,e)):await be(e),m.success("保存成功"),v.value=!1,A()}catch(e){console.error(e),m.error("保存失败")}finally{C.value=!1}}})},J=async l=>{try{await ve.confirm("确定要删除该用户吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await he(l.id),m.success("删除成功"),await A()}catch(e){e!=="cancel"&&(console.error(e),m.error("删除失败"))}},I=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"):"",K=async l=>{l.statusLoading=!0;try{await w(l.id,{is_active:l.is_active}),m.success(`已${l.is_active?"启用":"禁用"}用户`)}catch(e){console.error(e),m.error("更新状态失败"),l.is_active=!l.is_active}finally{l.statusLoading=!1}},k=c(!1),j=c("notes"),q=c([]),M=c([]),x=c(!1),$=c(!1),W=async l=>{s.value=l,k.value=!0,await Promise.all([X(),Y()])},X=async()=>{if(s.value){x.value=!0;try{const l=await ye();q.value=l.data.results.map(e=>{var d;return{...e,hasAuth:(d=s.value.notes)==null?void 0:d.includes(e.id)}})}catch(l){console.error(l),m.error("获取笔记列表失败")}finally{x.value=!1}}},Y=async()=>{if(s.value){$.value=!0;try{const l=await we();M.value=l.data.map(e=>{var d;return{...e,hasAuth:(d=s.value.note_group)==null?void 0:d.includes(e.id)}})}catch(l){console.error(l),m.error("获取分组列表失败")}finally{$.value=!1}}},Z=async l=>{var e,d;if(s.value)try{const r=l.hasAuth?[...s.value.notes||[],l.id]:(s.value.notes||[]).filter(u=>u!==l.id);await w(s.value.id,{note:r,note_group:s.value.note_group||[]}),s.value.notes=r,m.success("笔记授权更新成功")}catch(r){console.error(r),m.error(((d=(e=r.response)==null?void 0:e.data)==null?void 0:d.detail)||"笔记授权更新失败"),l.hasAuth=!l.hasAuth}},ee=async l=>{var e,d;if(s.value)try{const r=l.hasAuth?[...s.value.note_group||[],l.id]:(s.value.note_group||[]).filter(u=>u!==l.id);await w(s.value.id,{note:s.value.notes||[],note_group:r}),s.value.note_group=r,m.success("分组授权更新成功")}catch(r){console.error(r),m.error(((d=(e=r.response)==null?void 0:e.data)==null?void 0:d.detail)||"分组授权更新失败"),l.hasAuth=!l.hasAuth}};return re(()=>{A()}),(l,e)=>{var R;const d=i("el-icon"),r=i("el-button"),u=i("el-table-column"),ae=i("el-tag"),b=i("el-switch"),le=i("el-button-group"),N=i("el-table"),V=i("el-input"),f=i("el-form-item"),S=i("el-option"),te=i("el-select"),oe=i("el-form"),F=i("el-dialog"),P=i("el-tab-pane"),ne=i("el-tabs"),B=me("loading");return h(),ie("div",Ue,[de("div",Ce,[a(r,{type:"primary",onClick:H},{default:o(()=>[a(d,null,{default:o(()=>[a(y(ce))]),_:1}),e[11]||(e[11]=_("新建用户 "))]),_:1})]),D((h(),L(N,{data:T.value,stripe:""},{default:o(()=>[a(u,{prop:"username",label:"用户名"}),a(u,{prop:"first_name",label:"姓"}),a(u,{prop:"last_name",label:"名"}),a(u,{prop:"email",label:"邮箱"}),a(u,{prop:"role",label:"角色"},{default:o(({row:t})=>[a(ae,null,{default:o(()=>[_(E(t.role),1)]),_:2},1024)]),_:1}),a(u,{prop:"is_active",label:"状态",width:"100"},{default:o(({row:t})=>[a(b,{modelValue:t.is_active,"onUpdate:modelValue":p=>t.is_active=p,loading:t.statusLoading,onChange:p=>K(t),"active-text":t.is_active?"启用":"禁用","inline-prompt":""},null,8,["modelValue","onUpdate:modelValue","loading","onChange","active-text"])]),_:1}),a(u,{prop:"last_active_at",label:"最后活跃时间"},{default:o(({row:t})=>[_(E(I(t.last_active_at)),1)]),_:1}),a(u,{prop:"date_joined",label:"加入时间"},{default:o(({row:t})=>[_(E(I(t.date_joined)),1)]),_:1}),a(u,{label:"操作",width:"280",fixed:"right"},{default:o(({row:t})=>[a(le,null,{default:o(()=>[a(r,{type:"primary",icon:y(pe),onClick:p=>O(t)},{default:o(()=>e[12]||(e[12]=[_(" 编辑 ")])),_:2},1032,["icon","onClick"]),a(r,{type:"success",icon:y(_e),onClick:p=>W(t)},{default:o(()=>e[13]||(e[13]=[_(" 授权 ")])),_:2},1032,["icon","onClick"]),a(r,{type:"danger",icon:y(fe),onClick:p=>J(t)},{default:o(()=>e[14]||(e[14]=[_(" 删除 ")])),_:2},1032,["icon","onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[B,U.value]]),a(F,{title:s.value?"编辑用户":"新建用户",modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=t=>v.value=t),width:"500px",onClose:G},{footer:o(()=>[a(r,{onClick:e[7]||(e[7]=t=>v.value=!1)},{default:o(()=>e[15]||(e[15]=[_("取消")])),_:1}),a(r,{type:"primary",onClick:Q,loading:C.value},{default:o(()=>e[16]||(e[16]=[_(" 确定 ")])),_:1},8,["loading"])]),default:o(()=>[a(oe,{model:n,rules:z,ref_key:"formRef",ref:g,"label-width":"80px"},{default:o(()=>[a(f,{label:"用户名",prop:"username"},{default:o(()=>[a(V,{modelValue:n.username,"onUpdate:modelValue":e[0]||(e[0]=t=>n.username=t)},null,8,["modelValue"])]),_:1}),a(f,{label:"密码",prop:"password",rules:s.value?[]:[{required:!0,message:"请输入密码"}]},{default:o(()=>[a(V,{modelValue:n.password,"onUpdate:modelValue":e[1]||(e[1]=t=>n.password=t),type:"password"},null,8,["modelValue"])]),_:1},8,["rules"]),a(f,{label:"姓",prop:"first_name"},{default:o(()=>[a(V,{modelValue:n.first_name,"onUpdate:modelValue":e[2]||(e[2]=t=>n.first_name=t)},null,8,["modelValue"])]),_:1}),a(f,{label:"名",prop:"last_name"},{default:o(()=>[a(V,{modelValue:n.last_name,"onUpdate:modelValue":e[3]||(e[3]=t=>n.last_name=t)},null,8,["modelValue"])]),_:1}),a(f,{label:"邮箱",prop:"email"},{default:o(()=>[a(V,{modelValue:n.email,"onUpdate:modelValue":e[4]||(e[4]=t=>n.email=t)},null,8,["modelValue"])]),_:1}),a(f,{label:"角色",prop:"role"},{default:o(()=>[a(te,{modelValue:n.role,"onUpdate:modelValue":e[5]||(e[5]=t=>n.role=t)},{default:o(()=>[a(S,{label:"管理员",value:"admin"}),a(S,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),a(f,{label:"状态",prop:"is_active"},{default:o(()=>[a(b,{modelValue:n.is_active,"onUpdate:modelValue":e[6]||(e[6]=t=>n.is_active=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),a(F,{modelValue:k.value,"onUpdate:modelValue":e[10]||(e[10]=t=>k.value=t),title:`${((R=s.value)==null?void 0:R.name)||""} 的授权管理`,width:"800px"},{default:o(()=>[a(ne,{modelValue:j.value,"onUpdate:modelValue":e[9]||(e[9]=t=>j.value=t)},{default:o(()=>[a(P,{label:"笔记授权",name:"notes"},{default:o(()=>[D((h(),L(N,{data:q.value,style:{width:"100%"}},{default:o(()=>[a(u,{prop:"title",label:"笔记名称"}),a(u,{prop:"group_detail.name",label:"所属分组"}),a(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[a(b,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>Z(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[B,x.value]])]),_:1}),a(P,{label:"分组授权",name:"groups"},{default:o(()=>[D((h(),L(N,{data:M.value,style:{width:"100%"}},{default:o(()=>[a(u,{prop:"name",label:"分组名称"}),a(u,{prop:"description",label:"描述"}),a(u,{label:"授权",width:"100",align:"center"},{default:o(({row:t})=>[a(b,{modelValue:t.hasAuth,"onUpdate:modelValue":p=>t.hasAuth=p,onChange:p=>ee(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[B,$.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),Ne=ge(Ae,[["__scopeId","data-v-976f4911"]]);export{Ne as default};

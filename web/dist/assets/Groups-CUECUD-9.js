import{d as Ae,C as te,r,a as Ge,u as Ue,y as le,D as $e,q as Ne,o as Ee,c as ae,b as v,e as t,w as l,j as p,G as R,t as h,E as f,g as s,H as Be,h as De,i as m,I as Le,m as c,J as Se,K as Te,L as Fe,x as b,N as oe,O as ne,A as se,P as re,F as Ie,s as Me,Q as je,S as Re,_ as qe}from"./index-Br0JMTEE.js";import{d as Ke,j as Oe,k as ze,l as He,f as Je,u as Pe,c as Qe}from"./index-CPWKPUAP.js";import{r as We}from"./relativeTime-D_tPmCV5.js";const Xe={class:"groups-container"},Ye={class:"header"},Ze={class:"left"},et={class:"right"},tt={class:"group-header"},lt={class:"title"},at={class:"group-content"},ot={class:"group-footer"},nt={class:"time"},st=Ae({__name:"Groups",setup(rt){te.extend(We);const U=r("grid"),de=o=>te(o).fromNow(),$=r([]),N=r(!1),E=r(!1),g=r(!1),C=r(),_=Ge({name:"",description:""}),ue={name:[{required:!0,message:"请输入分组名称",trigger:"blur"}]},B=async()=>{N.value=!0;try{const o=await Ke();$.value=o.data||[]}catch(o){console.error("获取分组失败:",o),f.error("获取分组失败")}finally{N.value=!1}},q=()=>{C.value&&C.value.resetFields(),_.name="",_.description=""},ie=()=>{q(),g.value=!0},K=o=>{w.value=o,_.name=o.name,_.description=o.description||"",g.value=!0},ce=async()=>{C.value&&await C.value.validate(async o=>{if(o){E.value=!0;try{w.value?await Oe(w.value.id,_):await ze(_),f.success("保存成功"),g.value=!1,B()}catch(e){console.error("保存失败:",e),f.error("保存失败")}finally{E.value=!1}}})},O=async o=>{try{await je.confirm("删除分组将同时删除该分组下的所有笔记，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await He(o.id),f.success("删除成功"),await B()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),f.error("删除失败"))}},D=r(!1),z=r([]),L=r(!1),y=r(null),x=Ue(),S=le(()=>{var o,e;return((o=x.user)==null?void 0:o.role)==="admin"||((e=x.user)==null?void 0:e.role)==="superuser"}),A=o=>{var e,d,n;return((e=x.user)==null?void 0:e.role)==="admin"||((d=o.creator)==null?void 0:d.id)===((n=x.user)==null?void 0:n.id)},H=async o=>{y.value=o,D.value=!0,await pe()},pe=async()=>{if(y.value){L.value=!0;try{const o=await Je();z.value=o.data.map(e=>({...e,hasAuth:Array.isArray(e.note_group)&&e.note_group.includes(y.value.id)}))}catch(o){console.error(o),f.error("获取用户列表失败")}finally{L.value=!1}}},_e=async o=>{var e,d;if(y.value)try{const n=Array.isArray(o.note_group)?[...o.note_group]:[];if(o.hasAuth)n.includes(y.value.id)||n.push(y.value.id);else{const k=n.indexOf(y.value.id);k>-1&&n.splice(k,1)}await Pe(o.id,{note_group:n,note:o.notes||[]}),o.note_group=n,f.success("授权更新成功")}catch(n){console.error(n),f.error(((d=(e=n.response)==null?void 0:e.data)==null?void 0:d.detail)||"授权更新失败"),o.hasAuth=!o.hasAuth}},V=r(""),J=le(()=>{if(!V.value)return $.value;const o=V.value.toLowerCase();return $.value.filter(e=>e.name.toLowerCase().includes(o)||e.description&&e.description.toLowerCase().includes(o))}),P=$e(()=>{},300);Ne(V,()=>{P()});const G=r(!1),Q=r([]),T=r(!1),w=r(null),W=async o=>{w.value=o,G.value=!0,await fe(o.id)},fe=async o=>{T.value=!0;try{const e=await Qe({group__id:o});Q.value=e.data.results||[]}catch(e){console.error(e),f.error("获取笔记列表失败")}finally{T.value=!1}},me=De(),ve=o=>{G.value=!1,me.push(`/notes/view/${o.id}`)};return Ee(()=>{B()}),(o,e)=>{var Z;const d=s("el-icon"),n=s("el-button"),k=s("el-input"),X=s("el-radio-button"),ye=s("el-radio-group"),i=s("el-table-column"),he=s("el-button-group"),F=s("el-table"),I=s("el-dropdown-item"),be=s("el-dropdown-menu"),ge=s("el-dropdown"),we=s("el-card"),ke=s("el-col"),Ce=s("el-row"),Y=s("el-form-item"),Ve=s("el-form"),M=s("el-dialog"),xe=s("el-switch"),j=Be("loading");return m(),ae("div",Xe,[v("div",Ye,[v("div",Ze,[t(n,{type:"primary",onClick:ie},{default:l(()=>[t(d,null,{default:l(()=>[t(p(Le))]),_:1}),e[8]||(e[8]=c("新建分组 "))]),_:1})]),v("div",et,[t(k,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=a=>V.value=a),placeholder:"搜索分组",class:"search-input",onInput:p(P)},{prefix:l(()=>[t(d,null,{default:l(()=>[t(p(Se))]),_:1})]),_:1},8,["modelValue","onInput"]),t(ye,{modelValue:U.value,"onUpdate:modelValue":e[1]||(e[1]=a=>U.value=a),size:"small"},{default:l(()=>[t(X,{value:"table"},{default:l(()=>[t(d,null,{default:l(()=>[t(p(Te))]),_:1})]),_:1}),t(X,{value:"grid"},{default:l(()=>[t(d,null,{default:l(()=>[t(p(Fe))]),_:1})]),_:1})]),_:1},8,["modelValue"])])]),U.value==="table"?R((m(),h(F,{key:0,data:J.value,stripe:""},{default:l(()=>[t(i,{prop:"name",label:"名称"}),t(i,{prop:"description",label:"描述"}),t(i,{prop:"note_count",label:"笔记数量",width:"120",align:"center"},{default:l(({row:a})=>[t(n,{link:"",style:{color:"#E6A23C"},onClick:u=>W(a)},{default:l(()=>[c(b(a.note_count)+" 篇笔记 ",1)]),_:2},1032,["onClick"])]),_:1}),t(i,{prop:"created_at",label:"创建时间",width:"180"}),t(i,{prop:"updated_at",label:"更新时间",width:"180"}),t(i,{label:"操作",width:S.value?280:200,fixed:"right"},{default:l(({row:a})=>[t(he,null,{default:l(()=>[t(n,{type:"primary",icon:p(oe),onClick:u=>K(a),disabled:!A(a)},{default:l(()=>e[9]||(e[9]=[c(" 编辑 ")])),_:2},1032,["icon","onClick","disabled"]),S.value?(m(),h(n,{key:0,type:"success",icon:p(ne),onClick:u=>H(a)},{default:l(()=>e[10]||(e[10]=[c(" 授权 ")])),_:2},1032,["icon","onClick"])):se("",!0),t(n,{type:"danger",icon:p(re),onClick:u=>O(a),disabled:!A(a)},{default:l(()=>e[11]||(e[11]=[c(" 删除 ")])),_:2},1032,["icon","onClick","disabled"])]),_:2},1024)]),_:1},8,["width"])]),_:1},8,["data"])),[[j,N.value]]):(m(),h(Ce,{key:1,gutter:20},{default:l(()=>[(m(!0),ae(Ie,null,Me(J.value,a=>(m(),h(ke,{span:6,key:a.id},{default:l(()=>[t(we,{class:"group-card","body-style":{padding:"15px"},shadow:"hover"},{default:l(()=>[v("div",tt,[v("span",lt,b(a.name),1),t(ge,{trigger:"click"},{dropdown:l(()=>[t(be,null,{default:l(()=>[t(I,{onClick:u=>K(a),disabled:!A(a)},{default:l(()=>[t(d,null,{default:l(()=>[t(p(oe))]),_:1}),e[12]||(e[12]=c("编辑 "))]),_:2},1032,["onClick","disabled"]),S.value?(m(),h(I,{key:0,onClick:u=>H(a)},{default:l(()=>[t(d,null,{default:l(()=>[t(p(ne))]),_:1}),e[13]||(e[13]=c("授权 "))]),_:2},1032,["onClick"])):se("",!0),t(I,{onClick:u=>O(a),disabled:!A(a),class:"danger"},{default:l(()=>[t(d,null,{default:l(()=>[t(p(re))]),_:1}),e[14]||(e[14]=c("删除 "))]),_:2},1032,["onClick","disabled"])]),_:2},1024)]),default:l(()=>[t(n,{link:""},{default:l(()=>[t(d,null,{default:l(()=>[t(p(Re))]),_:1})]),_:1})]),_:2},1024)]),v("div",at,b(a.description||"暂无描述"),1),v("div",ot,[t(n,{link:"",style:{color:"#E6A23C"},onClick:u=>W(a)},{default:l(()=>[c(b(a.note_count)+" 篇笔记 ",1)]),_:2},1032,["onClick"]),v("span",nt,b(de(a.updated_at)),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1})),t(M,{title:w.value?"编辑分组":"新建分组",modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=a=>g.value=a),width:"500px",onClose:q},{footer:l(()=>[t(n,{onClick:e[4]||(e[4]=a=>g.value=!1)},{default:l(()=>e[15]||(e[15]=[c("取消")])),_:1}),t(n,{type:"primary",onClick:ce,loading:E.value},{default:l(()=>e[16]||(e[16]=[c(" 确定 ")])),_:1},8,["loading"])]),default:l(()=>[t(Ve,{model:_,rules:ue,ref_key:"formRef",ref:C,"label-width":"80px"},{default:l(()=>[t(Y,{label:"名称",prop:"name"},{default:l(()=>[t(k,{modelValue:_.name,"onUpdate:modelValue":e[2]||(e[2]=a=>_.name=a),placeholder:"请输入分组名称"},null,8,["modelValue"])]),_:1}),t(Y,{label:"描述",prop:"description"},{default:l(()=>[t(k,{modelValue:_.description,"onUpdate:modelValue":e[3]||(e[3]=a=>_.description=a),type:"textarea",rows:3,placeholder:"请输入分组描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),t(M,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=a=>D.value=a),title:"分组授权",width:"600px"},{default:l(()=>[R((m(),h(F,{data:z.value,style:{width:"100%"}},{default:l(()=>[t(i,{prop:"username",label:"用户名"}),t(i,{prop:"name",label:"姓名"}),t(i,{label:"授权",width:"100"},{default:l(({row:a})=>[t(xe,{modelValue:a.hasAuth,"onUpdate:modelValue":u=>a.hasAuth=u,onChange:u=>_e(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[j,L.value]])]),_:1},8,["modelValue"]),t(M,{modelValue:G.value,"onUpdate:modelValue":e[7]||(e[7]=a=>G.value=a),title:`${((Z=w.value)==null?void 0:Z.name)||""} 的笔记列表`,width:"800px"},{default:l(()=>[R((m(),h(F,{data:Q.value,style:{width:"100%"}},{default:l(()=>[t(i,{prop:"title",label:"笔记名称"},{default:l(({row:a})=>[t(n,{link:"",style:{color:"#E6A23C"},onClick:u=>ve(a)},{default:l(()=>[c(b(a.title),1)]),_:2},1032,["onClick"])]),_:1}),t(i,{label:"创建人"},{default:l(({row:a})=>{var u,ee;return[c(b(((u=a.creator)==null?void 0:u.name)||((ee=a.creator)==null?void 0:ee.username)),1)]}),_:1}),t(i,{prop:"created_at",label:"创建时间",width:"180"}),t(i,{prop:"updated_at",label:"更新时间",width:"180"})]),_:1},8,["data"])),[[j,T.value]])]),_:1},8,["modelValue","title"])])}}}),ct=qe(st,[["__scopeId","data-v-df3c3f89"]]);export{ct as default};

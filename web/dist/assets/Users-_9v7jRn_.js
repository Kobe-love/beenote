import{d as ce,r as c,a as _e,u as fe,y as ve,o as ge,c as be,b as ye,e as t,w as s,G as j,t as A,E as d,g as m,H as Ve,i as h,j as g,I as he,m as _,x as w,N as we,O as Ce,A as Ue,P as Ae,Q as ke,_ as xe}from"./index-Br0JMTEE.js";import{f as $e,u as k,m as Ne,n as Be,c as Le,d as De}from"./index-CPWKPUAP.js";const Me={class:"users-container"},Te={class:"header"},Se=ce({__name:"Users",setup(je){const E=c([]),x=c(!1),$=c(!1),y=c(!1),n=c(null),C=c(),o=_e({username:"",password:"",first_name:"",last_name:"",email:"",role:"user",is_active:!0}),Q={username:[{required:!0,message:"请输入用户名"}],email:[{type:"email",message:"请输入正确的邮箱地址"}]},N=async()=>{x.value=!0;try{const a=await $e();E.value=a.data.map(e=>({...e,statusLoading:!1}))}catch(a){console.error(a),d.error("获取用户列表失败")}finally{x.value=!1}},J=()=>{C.value&&C.value.resetFields(),o.username="",o.password="",o.first_name="",o.last_name="",o.email="",o.role="user",o.is_active=!0,n.value=null},K=()=>{J(),y.value=!0},W=a=>{n.value=a,Object.assign(o,{username:a.username,password:"",first_name:a.first_name,last_name:a.last_name,email:a.email,role:a.role,is_active:a.is_active}),y.value=!0},X=async a=>{a&&await a.validate(async e=>{var u;if(e){$.value=!0;try{const r={username:o.username,first_name:o.first_name,last_name:o.last_name,email:o.email,role:o.role,is_active:o.is_active};o.password.trim()&&(n==null?void 0:n.username)!==((u=f.user)==null?void 0:u.username)&&(r.password=o.password),n.value?(await k(n.value.id,r),d.success("更新成功")):(await Ne(r),d.success("创建成功")),y.value=!1,await N()}catch(r){console.error(r),d.error("保存失败")}finally{$.value=!1}}})},Y=async a=>{var e;if(a.username===((e=f.user)==null?void 0:e.username)){d.warning("不能删除自己的账号");return}try{await ke.confirm("确定要删除该用户吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Be(a.id),d.success("删除成功"),await N()}catch(u){u!=="cancel"&&(console.error(u),d.error("删除失败"))}},G=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-"):"",Z=async a=>{var e;if(a.username===((e=f.user)==null?void 0:e.username)&&!a.is_active){d.warning("不能禁用自己的账号"),a.is_active=!0;return}a.statusLoading=!0;try{await k(a.id,{is_active:a.is_active}),d.success(`已${a.is_active?"启用":"禁用"}用户`)}catch(u){console.error(u),d.error("更新状态失败"),a.is_active=!a.is_active}finally{a.statusLoading=!1}},B=c(!1),I=c("notes"),R=c([]),q=c([]),L=c(!1),D=c(!1),ee=async a=>{n.value=a,B.value=!0,await Promise.all([ae(),le()])},ae=async()=>{if(n.value){L.value=!0;try{const a=await Le();R.value=a.data.results.map(e=>{var u;return{...e,hasAuth:(u=n.value.notes)==null?void 0:u.includes(e.id)}})}catch(a){console.error(a),d.error("获取笔记列表失败")}finally{L.value=!1}}},le=async()=>{if(n.value){D.value=!0;try{const a=await De();q.value=a.data.map(e=>{var u;return{...e,hasAuth:(u=n.value.note_group)==null?void 0:u.includes(e.id)}})}catch(a){console.error(a),d.error("获取分组列表失败")}finally{D.value=!1}}},te=async a=>{var e,u;if(n.value)try{const r=a.hasAuth?[...n.value.notes||[],a.id]:(n.value.notes||[]).filter(i=>i!==a.id);await k(n.value.id,{note:r,note_group:n.value.note_group||[]}),n.value.notes=r,d.success("笔记授权更新成功")}catch(r){console.error(r),d.error(((u=(e=r.response)==null?void 0:e.data)==null?void 0:u.detail)||"笔记授权更新失败"),a.hasAuth=!a.hasAuth}},se=async a=>{var e,u;if(n.value)try{const r=a.hasAuth?[...n.value.note_group||[],a.id]:(n.value.note_group||[]).filter(i=>i!==a.id);await k(n.value.id,{note:n.value.notes||[],note_group:r}),n.value.note_group=r,d.success("分组授权更新成功")}catch(r){console.error(r),d.error(((u=(e=r.response)==null?void 0:e.data)==null?void 0:u.detail)||"分组授权更新失败"),a.hasAuth=!a.hasAuth}},f=fe(),F=ve(()=>{var a,e;return((a=f.user)==null?void 0:a.role)==="admin"||((e=f.user)==null?void 0:e.role)==="superuser"}),oe=a=>({superuser:"超级管理员",admin:"管理员",user:"普通用户"})[a]||a,ne=a=>({superuser:"danger",admin:"warning",user:"success"})[a]||"";return ge(()=>{N()}),(a,e)=>{var z;const u=m("el-icon"),r=m("el-button"),i=m("el-table-column"),re=m("el-tag"),U=m("el-switch"),ue=m("el-button-group"),M=m("el-table"),V=m("el-input"),b=m("el-form-item"),T=m("el-option"),ie=m("el-select"),de=m("el-form"),O=m("el-dialog"),P=m("el-tab-pane"),me=m("el-tabs"),S=Ve("loading");return h(),be("div",Me,[ye("div",Te,[t(r,{type:"primary",onClick:K},{default:s(()=>[t(u,null,{default:s(()=>[t(g(he))]),_:1}),e[12]||(e[12]=_("新建用户 "))]),_:1})]),j((h(),A(M,{data:E.value,stripe:""},{default:s(()=>[t(i,{prop:"username",label:"用户名"}),t(i,{prop:"first_name",label:"姓名"},{default:s(({row:l})=>[_(w(l.first_name)+" "+w(l.last_name),1)]),_:1}),t(i,{prop:"email",label:"邮箱"}),t(i,{prop:"role",label:"角色"},{default:s(({row:l})=>[t(re,{type:ne(l.role)},{default:s(()=>[_(w(oe(l.role)),1)]),_:2},1032,["type"])]),_:1}),t(i,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:l})=>{var p;return[t(U,{modelValue:l.is_active,"onUpdate:modelValue":v=>l.is_active=v,loading:l.statusLoading,onChange:v=>Z(l),"active-text":l.is_active?"启用":"禁用",disabled:l.username===((p=g(f).user)==null?void 0:p.username),"inline-prompt":""},null,8,["modelValue","onUpdate:modelValue","loading","onChange","active-text","disabled"])]}),_:1}),t(i,{prop:"last_active_at",label:"最后活跃时间"},{default:s(({row:l})=>[_(w(G(l.last_active_at)),1)]),_:1}),t(i,{prop:"date_joined",label:"加入时间"},{default:s(({row:l})=>[_(w(G(l.date_joined)),1)]),_:1}),t(i,{label:"操作",width:F.value?280:200,fixed:"right"},{default:s(({row:l})=>[t(ue,null,{default:s(()=>{var p;return[t(r,{type:"primary",icon:g(we),onClick:v=>W(l)},{default:s(()=>e[13]||(e[13]=[_(" 编辑 ")])),_:2},1032,["icon","onClick"]),F.value?(h(),A(r,{key:0,type:"success",icon:g(Ce),onClick:v=>ee(l)},{default:s(()=>e[14]||(e[14]=[_(" 授权 ")])),_:2},1032,["icon","onClick"])):Ue("",!0),t(r,{type:"danger",icon:g(Ae),disabled:l.username===((p=g(f).user)==null?void 0:p.username),onClick:v=>Y(l)},{default:s(()=>e[15]||(e[15]=[_(" 删除 ")])),_:2},1032,["icon","disabled","onClick"])]}),_:2},1024)]),_:1},8,["width"])]),_:1},8,["data"])),[[S,x.value]]),t(O,{modelValue:y.value,"onUpdate:modelValue":e[9]||(e[9]=l=>y.value=l),title:n.value?"编辑用户":"新建用户",width:"500px"},{footer:s(()=>[t(r,{onClick:e[7]||(e[7]=l=>y.value=!1)},{default:s(()=>e[16]||(e[16]=[_("取消")])),_:1}),t(r,{type:"primary",onClick:e[8]||(e[8]=l=>X(C.value)),loading:$.value},{default:s(()=>e[17]||(e[17]=[_(" 确定 ")])),_:1},8,["loading"])]),default:s(()=>[t(de,{ref_key:"formRef",ref:C,model:o,rules:Q,"label-width":"100px"},{default:s(()=>[t(b,{label:"用户名",prop:"username"},{default:s(()=>[t(V,{modelValue:o.username,"onUpdate:modelValue":e[0]||(e[0]=l=>o.username=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"密码",prop:"password",rules:[{required:!n.value,message:"请输入密码"}]},{default:s(()=>{var l,p,v,H;return[t(V,{modelValue:o.password,"onUpdate:modelValue":e[1]||(e[1]=pe=>o.password=pe),type:"password",disabled:((l=n.value)==null?void 0:l.username)===((p=g(f).user)==null?void 0:p.username),placeholder:((v=n.value)==null?void 0:v.username)===((H=g(f).user)==null?void 0:H.username)?"不能修改自己的密码":n.value?"不修改请留空":"请输入密码"},null,8,["modelValue","disabled","placeholder"])]}),_:1},8,["rules"]),t(b,{label:"姓",prop:"first_name"},{default:s(()=>[t(V,{modelValue:o.first_name,"onUpdate:modelValue":e[2]||(e[2]=l=>o.first_name=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"名",prop:"last_name"},{default:s(()=>[t(V,{modelValue:o.last_name,"onUpdate:modelValue":e[3]||(e[3]=l=>o.last_name=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"邮箱",prop:"email"},{default:s(()=>[t(V,{modelValue:o.email,"onUpdate:modelValue":e[4]||(e[4]=l=>o.email=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"角色",prop:"role"},{default:s(()=>[t(ie,{modelValue:o.role,"onUpdate:modelValue":e[5]||(e[5]=l=>o.role=l)},{default:s(()=>[t(T,{label:"超级管理员",value:"superuser"}),t(T,{label:"管理员",value:"admin"}),t(T,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1}),t(b,{label:"状态",prop:"is_active"},{default:s(()=>[t(U,{modelValue:o.is_active,"onUpdate:modelValue":e[6]||(e[6]=l=>o.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(O,{modelValue:B.value,"onUpdate:modelValue":e[11]||(e[11]=l=>B.value=l),title:`${((z=n.value)==null?void 0:z.name)||""} 的授权管理`,width:"800px"},{default:s(()=>[t(me,{modelValue:I.value,"onUpdate:modelValue":e[10]||(e[10]=l=>I.value=l)},{default:s(()=>[t(P,{label:"笔记授权",name:"notes"},{default:s(()=>[j((h(),A(M,{data:R.value,style:{width:"100%"}},{default:s(()=>[t(i,{prop:"title",label:"笔记名称"}),t(i,{prop:"group_detail.name",label:"所属分组"}),t(i,{label:"授权",width:"100",align:"center"},{default:s(({row:l})=>[t(U,{modelValue:l.hasAuth,"onUpdate:modelValue":p=>l.hasAuth=p,onChange:p=>te(l)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[S,L.value]])]),_:1}),t(P,{label:"分组授权",name:"groups"},{default:s(()=>[j((h(),A(M,{data:q.value,style:{width:"100%"}},{default:s(()=>[t(i,{prop:"name",label:"分组名称"}),t(i,{prop:"description",label:"描述"}),t(i,{label:"授权",width:"100",align:"center"},{default:s(({row:l})=>[t(U,{modelValue:l.hasAuth,"onUpdate:modelValue":p=>l.hasAuth=p,onChange:p=>se(l)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])),[[S,D.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])])}}}),Ie=xe(Se,[["__scopeId","data-v-bc3e5e00"]]);export{Ie as default};
